PSI - Plan de Sistemas de InformaciÃ³n
PSI 1: Inicio del Plan de Sistemas de InformaciÃ³n
Nombre del Proyecto
BuscaGas Localizador de gasolineras econÃ³micas en EspaÃ±a.

DescripciÃ³n y Objetivos
AplicaciÃ³n mÃ³vil para Android que permite a los usuarios localizar en tiempo real las gasolineras mÃ¡s econÃ³micas cercanas a su ubicaciÃ³n, utilizando datos oficiales del Ministerio para la TransiciÃ³n EcolÃ³gica y el Reto DemogrÃ¡fico del Gobierno de EspaÃ±a.

Objetivos especÃ­ficos
-Proporcionar informaciÃ³n actualizada de precios de combustible.
-Facilitar la localizaciÃ³n geogrÃ¡fica de gasolineras mediante mapa interactivo.
-Reducir el tiempo de bÃºsqueda del usuario a menos de 10 segundos.
-Ofrecer una interfaz simple y accesible.

Ãmbito del Sistema
-GeogrÃ¡fico: Territorio espaÃ±ol.
-Funcional: Consulta y visualizaciÃ³n de precios de combustible.
-TecnolÃ³gico: AplicaciÃ³n mÃ³vil nativa Android mediante Flutter.
-Usuarios: Conductores en EspaÃ±a con dispositivos Android.
EVS - Estudio de Viabilidad del Sistema
EVS 1: Establecimiento del Alcance del Sistema
DescripciÃ³n General del Sistema
Sistema de informaciÃ³n mÃ³vil que utiliza datos abiertos gubernamentales para presentar informaciÃ³n geolocalizada de estaciones de servicio de combustible y sus precios.

Alcance Funcional del MVP
Funcionalidades incluidas:
1. VisualizaciÃ³n de mapa interactivo centrado en la ubicaciÃ³n del usuario.
2. RepresentaciÃ³n de gasolineras mediante marcadores con cÃ³digo de color segÃºn precio.
3. Filtrado por tipo de combustible (Gasolina 95, DiÃ©sel GasÃ³leo A).
4. SincronizaciÃ³n periÃ³dica con API gubernamental.
5. ConfiguraciÃ³n de preferencias bÃ¡sicas (radio de bÃºsqueda, combustible preferido).
6. Modo claro/oscuro.
7. InformaciÃ³n bÃ¡sica al seleccionar marcador (tarjeta flotante).

Funcionalidades excluidas del MVP:
-Detalle de gasolinera en pantalla dedicada.
-Vista de lista ordenable.
-Sistema de favoritos.
-IntegraciÃ³n con navegaciÃ³n GPS externa.

Usuarios Identificados
-Usuario final: Conductor con smartphone Android que busca optimizar gasto en combustible.
EVS 2: Estudio de la SituaciÃ³n Actual
Fuentes de Datos
API oficial del Gobierno de EspaÃ±a:
-URL: https://datos.gob.es/es/catalogo/e05068001-precio-de-carburantes-en-las-gasolineras-espanolas
-Formato: JSON/XML.
-ActualizaciÃ³n: Datos oficiales actualizados periÃ³dicamente.
-Acceso: PÃºblico, sin autenticaciÃ³n.

Datos Relevantes por Gasolinera
-Identificador Ãºnico.
-Coordenadas geogrÃ¡ficas (latitud, longitud).
-DirecciÃ³n y localidad.
-Precios por tipo de combustible.
-Nombre del operador.

EVS 3: DefiniciÃ³n de Requisitos del Sistema
Requisitos Funcionales
RF-01: GeolocalizaciÃ³n
-El sistema debe obtener la ubicaciÃ³n actual del usuario mediante GPS.
-Debe solicitar permisos de ubicaciÃ³n al primer uso.
-Debe proporcionar botÃ³n de recentrado.

RF-02: VisualizaciÃ³n en Mapa
-El sistema mostrarÃ¡ mapa interactivo con marcadores de gasolineras.
-Los marcadores usarÃ¡n cÃ³digo de color segÃºn rango de precios.
-El mapa permitirÃ¡ zoom y desplazamiento.

RF-03: Filtrado por Combustible
-El usuario podrÃ¡ seleccionar entre Gasolina 95 o DiÃ©sel GasÃ³leo A.
-El filtro actualizarÃ¡ inmediatamente los marcadores visibles.

RF-04: ActualizaciÃ³n de Datos
-El sistema descargarÃ¡ datos de la API gubernamental al inicio.
-Se ejecutarÃ¡ actualizaciÃ³n automÃ¡tica periÃ³dica en segundo plano.
-El usuario serÃ¡ informado durante las cargas.

RF-05: InformaciÃ³n BÃ¡sica
-Al tocar un marcador, se mostrarÃ¡ tarjeta flotante con:
  Nombre de la gasolinera.
  Precio del combustible seleccionado.
  Distancia aproximada.

RF-06: ConfiguraciÃ³n
-Radio de bÃºsqueda configurable (5, 10, 20, 50 km).
-Combustible preferido por defecto.
-Alternancia entre modo claro/oscuro.

RF-07: Experiencia Inicial
-Pantalla de inicio con logo durante carga inicial.
-Solicitud de preferencia de tema claro/oscuro (solo primera ejecuciÃ³n).

Requisitos No Funcionales
RNF-01: Rendimiento
-Tiempo de carga inicial inferior a 3 segundos.
-Respuesta a interacciones de usuario inferior a 500ms.

RNF-02: Usabilidad
-El usuario debe encontrar la gasolinera mÃ¡s barata en menos de 10 segundos.
-Interfaz minimalista y clara.
-TipografÃ­a legible con precios destacados.

RNF-03: Compatibilidad
-Android 6.0 (API 23) o superior.

RNF-04: PrecisiÃ³n
-Los datos deben coincidir exactamente con la fuente oficial.
-Coordenadas con precisiÃ³n de al menos 100 metros.

RNF-05: Disponibilidad
-Funcionamiento offline con Ãºltima cachÃ© de datos (deseable).
-GestiÃ³n de errores de conexiÃ³n con mensajes claros.

RNF-06: Accesibilidad
-Contraste adecuado en ambos modos (claro/oscuro).
-TamaÃ±o de texto legible sin zoom.

EVS 4: Estudio de Alternativas de SoluciÃ³n
TecnologÃ­a de Desarrollo Seleccionada: Flutter.

Mapas: Google Maps Flutter Plugin.

Almacenamiento Local: SharedPreferences.

Opcional: Hive/SQLite.
-Para cachÃ© de datos de gasolineras.
-Consultas eficientes por proximidad geogrÃ¡fica.

ASI - AnÃ¡lisis del Sistema de InformaciÃ³n
ASI 1: DefiniciÃ³n del Sistema
DescripciÃ³n ArquitectÃ³nica
1. Capa de PresentaciÃ³n
-Widgets Flutter para UI.
-GestiÃ³n de temas (claro/oscuro).
-Componentes de mapa.

2. Capa de LÃ³gica de Negocio
-Filtrado de gasolineras por distancia y tipo de combustible.
-CÃ¡lculo de distancias geogrÃ¡ficas.
-ClasificaciÃ³n por rangos de precio.

3. Capa de Datos
-Cliente HTTP para API gubernamental.
-Parser de respuestas JSON/XML.
-CachÃ© local de datos.

4. Capa de Servicios del Sistema
-Servicio de geolocalizaciÃ³n.
-Servicio de mapas.
-Gestor de preferencias.

ASI 2: IdentificaciÃ³n de Subsistemas de AnÃ¡lisis
Subsistemas Identificados
SS-01: GestiÃ³n de UbicaciÃ³n
-ObtenciÃ³n de permisos.
-Lectura de coordenadas GPS.
-Recentrado de mapa.

SS-02: GestiÃ³n de Datos de Combustible
-Descarga desde API.
-Parsing y validaciÃ³n.
-ActualizaciÃ³n periÃ³dica.
-Almacenamiento en cachÃ©.

SS-03: VisualizaciÃ³n CartogrÃ¡fica
-Renderizado de mapa.
-GestiÃ³n de marcadores.
-CÃ³digo de color segÃºn precio.
-InteracciÃ³n tÃ¡ctil.

SS-04: Filtrado y BÃºsqueda
-Filtro por tipo de combustible.
-Filtro por radio de distancia.
-CÃ¡lculo de distancias.
-OrdenaciÃ³n por precio.

SS-05: ConfiguraciÃ³n de Usuario
-Almacenamiento de preferencias.
-GestiÃ³n de temas visuales.
-ConfiguraciÃ³n de parÃ¡metros de bÃºsqueda.

SS-06: Interfaz de Usuario
-Pantalla de inicio.
-Pantalla principal (mapa).
-Pantalla de configuraciÃ³n.
-Tarjetas informativas.

ASI 3: AnÃ¡lisis de Casos de Uso
CU-01: Localizar Gasolinera MÃ¡s Barata
Actor: Usuario conductor

Precondiciones:
-AplicaciÃ³n instalada.
-Permisos de ubicaciÃ³n concedidos.
-ConexiÃ³n a internet disponible.

Flujo Principal:
1. Usuario abre la aplicaciÃ³n.
2. Sistema solicita ubicaciÃ³n GPS.
3. Sistema descarga datos de API gubernamental.
4. Sistema calcula distancias a gasolineras cercanas.
5. Sistema filtra por combustible seleccionado y radio configurado.
6. Sistema muestra mapa con marcadores coloreados.
7. Usuario visualiza marcadores (verde=barato, rojo=caro).
8. Usuario identifica gasolinera mÃ¡s econÃ³mica cercana.
9. [Opcional] Usuario toca marcador para ver detalles.

Flujo Alternativo 4a: Sin conexiÃ³n
-Sistema muestra mensaje de error.
-Sistema carga Ãºltima cachÃ© disponible (si existe).

Postcondiciones:
-Usuario tiene informaciÃ³n actualizada de precios.
-Sistema ha almacenado datos en cachÃ©.

CU-02: Configurar Preferencias
Actor: Usuario conductor.

Precondiciones:
-AplicaciÃ³n ejecutÃ¡ndose.

Flujo Principal:
1. Usuario toca icono de configuraciÃ³n (engranaje).
2. Sistema muestra pantalla de configuraciÃ³n.
3. Usuario modifica radio de bÃºsqueda (5/10/20/50 km).
4. Usuario selecciona combustible preferido.
5. Usuario alterna modo claro/oscuro.
6. Usuario regresa al mapa.
7. Sistema guarda preferencias.
8. Sistema aplica cambios inmediatamente.

Postcondiciones:
-Preferencias almacenadas persistentemente
-Interfaz actualizada segÃºn configuraciÃ³n

CU-03: Recentrar Mapa en UbicaciÃ³n Actual
Actor: Usuario conductor.

Precondiciones:
-Mapa visible.
-Permisos de ubicaciÃ³n activos.

Flujo Principal:
1. Usuario toca botÃ³n "Mi ubicaciÃ³n".
2. Sistema obtiene coordenadas GPS actuales.
3. Sistema centra mapa en nueva posiciÃ³n.
4. Sistema recalcula gasolineras dentro del radio.

Flujo Alternativo 2a: UbicaciÃ³n no disponible.
-Sistema muestra mensaje informativo.
-Sistema mantiene Ãºltima posiciÃ³n conocida.

Postcondiciones:
-Mapa centrado en ubicaciÃ³n actual.
-Datos actualizados para nueva posiciÃ³n.

ASI 4: AnÃ¡lisis de Clases
Modelo de Dominio
+------------+           uses            +-------------+
|  Usuario   | ------------------------> | AplicaciÃ³n  |
+------------+                           +-------------+
                                           |
                                           | manages
                                           v
                                    +-----------------+
                                    | ConfiguraciÃ³n   |
                                    |-----------------|
                                    | radioBusqueda   |
                                    | combustiblePref |
                                    | temaOscuro      |
                                    +-----------------+

                                    +-----------------+
                                    |   Gasolinera    |
                                    |-----------------|
                                    | id              |
                                    | nombre          |
                                    | latitud         |
                                    | longitud        |
                                    | direccion       |
                                    | localidad       |
                                    | operador        |
                                    | precios[]       |
                                    +-----------------+
                                           ^
                                           | contains (1..*)
                                           |
                                    +-----------------+
                                    |     Precio      |
                                    |-----------------|
                                    | tipo            |
                                    | valor           |
                                    | fechaActualiz.  |
                                    +-----------------+
Clases Principales
Clase: Gasolinera
class Gasolinera {
  String id;
  String nombre;
  double latitud;
  double longitud;
  String direccion;
  String localidad;
  String operador;
  List<Precio> precios;
  
  double? getPrecio(TipoCombustible tipo);
  double calcularDistancia(double lat, double lon);
}

Clase: Precio
class Precio {
  TipoCombustible tipo;
  double valor;
  DateTime fechaActualizacion;
}

Clase: ConfiguraciÃ³n

class Configuracion {
  int radioBusqueda; // en km
  TipoCombustible combustiblePreferido;
  bool temaOscuro;
  
  void guardar();
  void cargar();
}

EnumeraciÃ³n: TipoCombustible
enum TipoCombustible {
  gasolina95,
  dieselGasoleoA
}

ASI 5: ElaboraciÃ³n del Modelo de Datos
Modelo Entidad-RelaciÃ³n LÃ³gico
+-------------------------------+          +----------------------------------+
|        CONFIGURACIÃ“N          |          |            GASOLINERA            |
|-------------------------------|          |----------------------------------|
| PK id   : INTEGER  (always 1) |          | PK idGasolinera : VARCHAR(50)    |
| radioBusqueda : INTEGER       |          | nombre          : VARCHAR(200)   |
| combustiblePref : VARCHAR(20) |          | latitud         : DECIMAL(10,8)  |
| temaOscuro      : BOOLEAN     |          | longitud        : DECIMAL(11,8)  |
| last_api_sync   : DATETIME?   |          | direccion       : VARCHAR(300)   |
+-------------------------------+          | localidad       : VARCHAR(100)   |
          (singleton)                      | operador        : VARCHAR(100)   |
                                           | fechaCache      : DATETIME       |
                                           +----------------------------------+
                                                         |
                                                         | 1
                                                         |
                                                         | *
                                              +----------------------------------+
                                              |              PRECIO              |
                                              |----------------------------------|
                                              | PK idPrecio        : INTEGER     |
                                              | FK idGasolinera    : VARCHAR(50) |
                                              | tipoCombustible    : VARCHAR(20) |
                                              | valor              : DECIMAL(5,3)|
                                              | fechaActualizacion : DATETIME    |
                                              +----------------------------------+
Diccionario de Datos
Tabla: GASOLINERA
+idGasolinera
-Tipo: VARCHAR(50)
-Nulo: NO
-DescripciÃ³n: Identificador Ãºnico proporcionado por la API

+nombre
-Tipo: VARCHAR(200)
-Nulo: NO
-DescripciÃ³n: Nombre comercial de la estaciÃ³n

+latitud
-Tipo: DECIMAL(10,8)
-Nulo: NO
-DescripciÃ³n: Coordenada de latitud (WGS84)

+longitud
-Tipo: DECIMAL(11,8)
-Nulo: NO
-DescripciÃ³n: Coordenada de longitud (WGS84)

+direccion
-Tipo: VARCHAR(300)
-Nulo: SÃ
-DescripciÃ³n: DirecciÃ³n completa (calle, nÃºmero, etc.)

+localidad
-Tipo: VARCHAR(100)
-Nulo: SÃ
-DescripciÃ³n: Nombre de la localidad o municipio

+operador
-Tipo: VARCHAR(100)
-Nulo: SÃ
-DescripciÃ³n: Empresa operadora de la estaciÃ³n

+fechaCache
-Tipo: DATETIME
-Nulo: NO
-DescripciÃ³n: Fecha y hora de la Ãºltima sincronizaciÃ³n/cachÃ©

Tabla: PRECIO
+idPrecio
-Tipo: INTEGER (autoincremental)
-Nulo: NO
-DescripciÃ³n: Identificador Ãºnico del registro de precio

+idGasolinera
-Tipo: VARCHAR(50)
-Nulo: NO
-DescripciÃ³n: Clave forÃ¡nea que referencia idGasolinera en la tabla GASOLINERA

+tipoCombustible
-Tipo: VARCHAR(20)
-Nulo: NO
-DescripciÃ³n: Tipo de combustible (por ejemplo: "gasolina95", "dieselGasoleoA")

+valor
-Tipo: DECIMAL(5,3)
-Nulo: NO
-DescripciÃ³n: Precio en euros por litro (ej.: 1.459)

+fecha ActualizaciÃ³n
-Tipo: DATETIME
-Nulo: NO
-DescripciÃ³n: Fecha y hora del dato oficial o de la Ãºltima actualizaciÃ³n del precio

Tabla: CONFIGURACION
+id
-Tipo: INTEGER
-Nulo: NO
-DescripciÃ³n: Identificador Ãºnico del registro de configuraciÃ³n (singleton â€” siempre 1)

+radioBusqueda
-Tipo: INTEGER
-Nulo: NO
-DescripciÃ³n: Radio de bÃºsqueda en kilÃ³metros (valores tÃ­picos: 5, 10, 20, 50)

+combustiblePref
-Tipo: VARCHAR(20)
-Nulo: NO
-DescripciÃ³n: Combustible preferido por defecto (ej.: 'gasolina95', 'dieselGasoleoA')

+temaOscuro
-Tipo: BOOLEAN
-Nulo: NO
-DescripciÃ³n: true = modo oscuro, false = modo claro

+last_api_sync
-Tipo: DATETIME
-Nulo: SÃ
-DescripciÃ³n: Fecha y hora de la Ãºltima sincronizaciÃ³n con la API (nulo si aÃºn no se ha sincronizado)

ASI 6: ElaboraciÃ³n del Modelo de Procesos
Diagrama de Flujo: Proceso Principal
+-------------------------------+
|           INICIO              |
+-------------------------------+
             |
             v
+-------------------------------+
| Mostrar Pantalla Inicio con   |
|            Logo               |
+-------------------------------+
             |
             v
+-------------------------------+
|  Â¿Primera EjecuciÃ³n?          |
+-------------------------------+
      |                |
     SÃ­               No
      |                |
      v                v
+----------------+   (continÃºa)
| Solicitar      |
| preferencia    |
| de tema (claro/|
| oscuro)        |
+----------------+
      |
      v
+-------------------------------+
|Solicitar permisos de ubicaciÃ³n|
+-------------------------------+
             |
             v
+-------------------------------+
| Â¿Permisos concedidos?         |
+-------------------------------+
      |                |
     No               SÃ­
      |                |
      v                v
+----------------+   +-----------------------+
| Mostrar mensaje|   | Obtener coordenadas   |
| explicativo y  |   | GPS actuales          |
|opciÃ³n de cerrar|   +-----------------------+
+----------------+       |
                         v
                 +-----------------------+
                 | Descargar datos desde |
                 | API del Gobierno      |
                 +-----------------------+
                         |
                         v
                 +-----------------------+
                 | Â¿Descarga exitosa?    |
                 +-----------------------+
                      |            |
                     No           SÃ­
                      |            |
                      v            v
             +----------------+  +-------------------+
             | Cargar cachÃ©   |  | Parsear JSON /    |
             |local(si existe)|  | validar datos     |
             +----------------+  +-------------------+
                      |            |
                      |            v
                      |     +-------------------+
                      |     | Guardar en cachÃ©  |
                      |     | local (DB)        |
                      |     +-------------------+
                      |            |
                      v            v
               (ambas ramas convergen aquÃ­)
                         +-----------------------+
                         | Cargar configuraciÃ³n  |
                         | de usuario (prefs)    |
                         +-----------------------+
                                     |
                                     v
                         +-----------------------+
                         | Filtrar gasolineras   |
                         | por radio (5/10/20/50)|
                         +-----------------------+
                                     |
                                     v
                         +-----------------------+
                         |Filtrar por combustible|
                         |preferido (95 / DiÃ©sel)|
                         +-----------------------+
                                     |
                                     v
                         +-----------------------+
                         | Calcular distancias   |
                         | (Haversine)           |
                         +-----------------------+
                                     |
                                     v
                         +-----------------------+
                         | Clasificar por rangos |
                         | de precio(percentiles)|
                         +-----------------------+
                                     |
                                     v
                         +-----------------------+
                         | Asignar color a       |
                         | marcadores (verde/    |
                         | amarillo/rojo)        |
                         +-----------------------+
                                     |
                                     v
                         +-----------------------+
                         | Mostrar mapa con      |
                         | marcadores            |
                         +-----------------------+
                                     |
                                     v
                         +-----------------------+
                         | Esperar interacciÃ³n   |
                         | del usuario           |
                         +-----------------------+
                                     |
                                     v
                         +-----------------------+
                         | Â¿AcciÃ³n del usuario?  |
                         +-----------------------+
            ___________________|____________________________
           |            |             |               |
           v            v             v               v
+----------------+ +----------------+ +----------------+ +--------------------+
| Cambiar        | | Abrir          | | Tocar marcador | | Recentrar mapa /   |
| combustible    | | configuraciÃ³n  | |(mostrar tarjeta)|| obtener nueva      |
| (selector)     | |(modificar prefs)|+----------------+ | ubicaciÃ³n GPS)     |
+----------------+ +----------------+         |          +--------------------+
      |                 |                    v                 |
      v                 v              +---------------+       v
+----------------+  +----------------+ | Volver a      | +---------------------+
| Actualizar     |  | Guardar prefs  | | Esperar       | | Actualizar mapa y   |
| vista / recalc |  | y aplicar      | | interacciÃ³n   | | recalcular gasol.   |
+----------------+  +----------------+ +---------------+ +---------------------+
           \______________________________|_____________________________/
                                          v
                         +-------------------------------+
                         | Continua ejecuciÃ³n normal /   |
                         | Espera nuevas interacciones   |
                         +-------------------------------+

(En paralelo)
+-------------------------------------------+
| ActualizaciÃ³n periÃ³dica en background     |
| - Timer (ej. cada 30 min)                 |
| - WorkManager (Android)                   |
| - Descarga, comparar, actualizar cachÃ©    |
| - Notificar UI si hay cambios             |
+-------------------------------------------+

Proceso: ActualizaciÃ³n de Datos
+------------------------------------------------+
| Timer PeriÃ³dico: cada X minutos                |
+------------------------------------------------+
                       |
                       v
+------------------------------------------------+
| Â¿Hay ConexiÃ³n a Internet?                      |
+------------------------------------------------+
         |                          |
        No                         SÃ­
         |                          |
         v                          v
+----------------------+    +-----------------------------+
|Cancelar ActualizaciÃ³n|    | Descargar Datos Frescos API |
+----------------------+    +-----------------------------+
                                      |
                                      v
                        +-------------------------------+
                        | Â¿Descarga exitosa?            |
                        +-------------------------------+
                             |                   |
                            No                  SÃ­
                             |                   |
                             v                   v
                  +-------------------+   +-------------------------+
                  | Mantener Datos    |   | Comparar con CachÃ©      |
                  | Actuales          |   | Actual                  |
                  +-------------------+   +-------------------------+
                                                   |
                                                   v
                                           +---------------------+
                                           | Â¿Hay Cambios?       |
                                           +---------------------+
                                                |           |
                                               No          SÃ­
                                                |           |
                                                v           v
                                      +----------------+  +---------------------------+
                                      | No hacer nada  |  | Actualizar Base de Datos  |
                                      +----------------+  | Local (DB)                |
                                                          +---------------------------+
                                                                    |
                                                                    v
                                                           +---------------------------+
                                                           | Recalcular marcadores     |
                                                           | visibles (por proximidad /|
                                                           | tipo de combustible)      |
                                                           +---------------------------+
                                                                    |
                                                                    v
                                                           +---------------------------+
                                                           | Actualizar vista sin      |
                                                           | interrumpir al usuario    |
                                                           +---------------------------+
                                                                    |
                                                                    v
                                                           +---------------------------+
                                                           | Registrar timestamp de la |
                                                           | actualizaciÃ³n             |
                                                           +---------------------------+
                                                                    |
                                                                    v
                                                               +--------+
                                                               |  FIN   |
                                                               +--------+
ASI 7: DefiniciÃ³n de Interfaces de Usuario
IU-01: Pantalla de Inicio
Elementos:
-Logo de BuscaGas (centrado).
-Indicador de carga (spinner).
-Texto: "Cargando datos...".
-[Solo primera vez] DiÃ¡logo: "Â¿Prefieres tema claro u oscuro?".

Comportamiento:
-DuraciÃ³n mÃ¡xima: 3 segundos.
-TransiciÃ³n automÃ¡tica a Pantalla Principal.

IU-02: Pantalla Principal - Mapa
Layout:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [âš™ï¸ ConfiguraciÃ³n]        BuscaGas        [     â”‚ â† Barra superior
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Gasolina 95]   [DiÃ©sel GasÃ³leo A]              â”‚ â† Selector combustible
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚                 [ MAPA INTERACTIVO ]            â”‚
â”‚                                                 â”‚
â”‚          ğŸ“ Marcadores con precios              â”‚
â”‚                                                 â”‚
â”‚                 ğŸ”µ Usuario aquÃ­                 â”‚
â”‚                                                 â”‚
â”‚                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                               [ğŸ“ Mi Loc]       â”‚ â† BotÃ³n recentrar
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Marcadores:
-Color verde: precio en rango bajo.
-Color amarillo: precio en rango medio.
-Color rojo: precio en rango alto.
-Icono: surtidor de gasolina.
-Label: precio en â‚¬/litro.

Tarjeta Flotante (al tocar marcador):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Repsol - Av. Principal 123  â”‚
â”‚ Gasolina 95: 1.45 â‚¬/L       â”‚
â”‚ ğŸ“ 0.8 km                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Interacciones:
-Pellizcar: zoom.
-Arrastrar: desplazar mapa.
-Tap en marcador: mostrar tarjeta.
-Tap en "Mi Loc": recentrar.
-Tap en selector combustible: filtrar.
-Tap en engranaje: abrir configuraciÃ³n.

IU-03: Pantalla de ConfiguraciÃ³n
Layout:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â† AtrÃ¡s]            ConfiguraciÃ³n              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  Radio de bÃºsqueda                              â”‚
â”‚  â—‹ 5 km                                         â”‚
â”‚  â— 10 km                                        â”‚
â”‚  â—‹ 20 km                                        â”‚
â”‚  â—‹ 50 km                                        â”‚
â”‚                                                 â”‚
â”‚  Combustible preferido                          â”‚
â”‚  [Dropdown: Gasolina 95           â–¼]            â”‚
â”‚                                                 â”‚
â”‚  Tema                                           â”‚
â”‚  [Toggle: â˜€ï¸ Claro  |  ğŸŒ™ Oscuro]               â”‚
â”‚                                                 â”‚
â”‚                   [ Volver al Mapa ]            â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Comportamiento:
-Cambios se aplican inmediatamente
-Al pulsar "Volver", regresa a pantalla de mapa
-Valores se persisten automÃ¡ticamente
ASI 8: AnÃ¡lisis de Consistencia y EspecificaciÃ³n de Requisitos
Matriz de Trazabilidad
+---------+---------------------------+-------------------+---------------------+------------+------------+
| Req ID  | Requisito                 | Caso(s) de Uso    | Clase               | Interfaz   | Subsistema |
+---------+---------------------------+-------------------+---------------------+------------+------------+
| RF-01   | GeolocalizaciÃ³n del       | CU-01, CU-04      | -                   | IU-02      | SS-01      |
|         | usuario                   |                   |                     |            |            |
+---------+---------------------------+-------------------+---------------------+------------+------------+
| RF-02   | VisualizaciÃ³n en mapa     | CU-01             | Gasolinera          | IU-02      | SS-03      |
+---------+---------------------------+-------------------+---------------------+------------+------------+
| RF-03   | Filtro por combustible    | CU-02             | TipoCombustible     | IU-02      | SS-04      |
+---------+---------------------------+-------------------+---------------------+------------+------------+
| RF-04   | Consumo de API oficial    | CU-01             | Gasolinera, Precio  | -          | SS-02      |
+---------+---------------------------+-------------------+---------------------+------------+------------+
| RF-05   | Tarjeta informativa       | CU-01             | Gasolinera          | IU-02      | SS-03      |
+---------+---------------------------+-------------------+---------------------+------------+------------+
| RF-06   | ConfiguraciÃ³n de          | CU-03             | Configuracion       | IU-03      | SS-05      |
|         | preferencias              |                   |                     |            |            |
+---------+---------------------------+-------------------+---------------------+------------+------------+
| RF-07   | ActualizaciÃ³n automÃ¡tica  | -                 | -                   | -          | SS-02      |
+---------+---------------------------+-------------------+---------------------+------------+------------+
| RF-08   | Pantalla de inicio        | CU-01             | -                   | IU-01      | SS-06      |
+---------+---------------------------+-------------------+---------------------+------------+------------+
ValidaciÃ³n de Completitud
-Todos los requisitos funcionales estÃ¡n cubiertos por casos de uso
-Todos los casos de uso tienen interfaces asociadas
-Todas las clases de dominio estÃ¡n representadas en el modelo de datos
-Todos los subsistemas tienen responsabilidades claras
DSI - DiseÃ±o del Sistema de InformaciÃ³n
DSI 1: DefiniciÃ³n de la Arquitectura del Sistema
Arquitectura General
PatrÃ³n ArquitectÃ³nico: Capas + Repository Pattern
+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+
|                      ARQUITECTURA GENERAL                      |
+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+

        +----------------------+         +----------------------+
        |  CAPA DE PRESENTACIÃ“N|         |      SERVICIOS       |
        | (Widgets, Screens,   |<--------| (location, maps,     |
        |  UI Logic, temas)    |         |  storage, sync)      |
        +----------+-----------+         +----------+-----------+
                   |                                ^
                   | usa / muestra                  |
                   v                                |
        +----------------------+                    |
        | CAPA DE LÃ“GICA DE    |--------------------+
        | NEGOCIO              |
        | (BLoC/Provider,      |
        |  Use Cases, reglas)  |
        +----------+-----------+
                   |
                   | solicita / orquesta
                   v
        +----------------------+    <-------------------------------+
        |     CAPA DE DATOS    |                                    |
        | (Repositories, DTOs, |                                    |
        |  Mappers, Cache)     |                                    |
        +----+----------+------+
             |          |
  obtiene    v          v  persiste/lee
  datos +-----------+  +-------------+
        | API REMOTA|  |  BD LOCAL   |
        | (Gobierno)|  |(SQLite/Hive)|
        +-----------+  +-------------+
Leyenda breve:
-CAPA DE PRESENTACIÃ“N: pantallas, widgets, selector de combustible, mapa.
-CAPA DE LÃ“GICA DE NEGOCIO: BLoC/Provider, casos de uso (getNearby, filter, calcDistance).
-CAPA DE DATOS: repositorios que combinan API remota y cachÃ© local.
-API REMOTA: endpoint oficial de precios del gobierno.
-BD LOCAL: cachÃ© de estaciones y precios para consultas offline/rÃ¡pidas.
-SERVICIOS: componentes del sistema (geolocalizaciÃ³n, cliente HTTP, gestor de sincronizaciÃ³n).

Componentes ArquitectÃ³nicos
1. PresentaciÃ³n
- `screens/`: Pantallas de la aplicaciÃ³n
  - `splash_screen.dart`
  - `map_screen.dart`
  - `settings_screen.dart`
- `widgets/`: Componentes reutilizables
  - `gas_station_marker.dart`
  - `info_card.dart`
  - `fuel_selector.dart`

2. LÃ³gica de Negocio
-`blocs/` o `providers/`:
   `map_bloc.dart`: Estado del mapa y marcadores
   `settings_bloc.dart`: ConfiguraciÃ³n de usuario
   `fuel_bloc.dart`: GestiÃ³n de datos de gasolineras
-`use_cases/`:
   `get_nearby_stations.dart`
   `filter_by_fuel_type.dart`
   `calculate_distance.dart`

3. Datos
-`repositories/`:
   `gas_station_repository.dart`: Interfaz abstracta
   `gas_station_repository_impl.dart`: ImplementaciÃ³n
-`data_sources/`:
   `remote/api_data_source.dart`
   `local/database_data_source.dart`
-`models/`:
   `gas_station_model.dart`
   `price_model.dart`

4. Servicios
-`services/`:
   `location_service.dart`: GPS y permisos
   `api_service.dart`: Cliente HTTP
   `storage_service.dart`: SharedPreferences
   `database_service.dart`: SQLite/Hive

DSI 2: DiseÃ±o de la Arquitectura de MÃ³dulos del Sistema
MÃ³dulos Principales
MÃ³dulo 1: Core
-ConfiguraciÃ³n global.
-Constantes.
-Utilidades comunes.
-GestiÃ³n de temas.

MÃ³dulo 2: Data
-Modelos de datos.
-Repositorios.
-Data sources (API y local).
-DTOs y mappers.

MÃ³dulo 3: Domain
- Entidades de negocio.
- Casos de uso.
- Interfaces de repositorios.
- Reglas de negocio.

MÃ³dulo 4: Presentation
-Screens.
-Widgets.
-State management (BLoC/Provider).
-NavegaciÃ³n.

MÃ³dulo 5: Services
-Servicios de terceros.
-Servicios del sistema (GPS, almacenamiento).

Diagrama de Dependencias
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Presentation  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ depende
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Domain     â”‚â—„â”€â”€â”€â”€â”€â”‚   Core   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ depende          â–²
        â–¼                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     Data      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ depende
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Services    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
DSI 3: DiseÃ±o de Casos de Uso Reales
DiseÃ±o Detallado CU-01: Localizar Gasolinera MÃ¡s Barata
Secuencia de Llamadas:
Usuario
  |
MapScreen
  |
MapBloc
  |
GetNearbyStationsUseCase
  |
GasStationRepository
  |---> ApiDataSource -> API Gobierno
  |
  |---> DatabaseDataSource (cachÃ©)
  |
Lista de Gasolineras
  |
MapBloc
  |
CalculateDistanceUseCase
  |
FilterByFuelTypeUseCase
  |
MapBloc emite nuevo estado
  |
MapScreen reconstruye marcadores actualizados

PseudocÃ³digo:
// MapBloc
void loadNearbyStations() async {
  emit(LoadingState());
  
  // 1. Obtener ubicaciÃ³n
  Position position = await locationService.getCurrentPosition();
  
  // 2. Obtener gasolineras
  try {
    List<GasStation> stations = await getNearbyStationsUseCase(
      latitude: position.latitude,
      longitude: position.longitude,
      radiusKm: settings.searchRadius
    );
    
    // 3. Filtrar por combustible
    stations = filterByFuelTypeUseCase(
      stations: stations,
      fuelType: settings.preferredFuel
    );
    
    // 4. Calcular distancias y ordenar
    for (var station in stations) {
      station.distance = calculateDistanceUseCase(
        position.latitude,
        position.longitude,
        station.latitude,
        station.longitude
      );
    }
    
    // 5. Clasificar por precio
    stations = classifyByPriceRange(stations);
    
    emit(LoadedState(stations: stations));
  } catch (e) {
    emit(ErrorState(message: e.toString()));
  }
}
DSI 4: DiseÃ±o de Clases
Clase: GasStation (Entity)
class GasStation {
  final String id;
  final String name;
  final double latitude;
  final double longitude;
  final String address;
  final String locality;
  final String operator;
  final List<FuelPrice> prices;
  double? distance; // calculado dinÃ¡micamente
  PriceRange? priceRange; // bajo, medio, alto
  
  GasStation({
    required this.id,
    required this.name,
    required this.latitude,
    required this.longitude,
    this.address = '',
    this.locality = '',
    this.operator = '',
    this.prices = const [],
  });
  
  double? getPriceForFuel(FuelType fuelType) {
    try {
      return prices
          .firstWhere((p) => p.fuelType == fuelType)
          .value;
    } catch (_) {
      return null;
    }
  }
  
  bool isWithinRadius(double lat, double lon, double radiusKm) {
    double distance = _calculateDistance(lat, lon);
    return distance <= radiusKm;
  }
  
  double _calculateDistance(double lat, double lon) {
    // FÃ³rmula de Haversine
    const double earthRadiusKm = 6371.0;
    
    double dLat = _degreesToRadians(latitude - lat);
    double dLon = _degreesToRadians(longitude - lon);
    
    double a = sin(dLat / 2) * sin(dLat / 2) +
        cos(_degreesToRadians(lat)) *
        cos(_degreesToRadians(latitude)) *
        sin(dLon / 2) * sin(dLon / 2);
    
    double c = 2 * atan2(sqrt(a), sqrt(1 - a));
    
    return earthRadiusKm * c;
  }
  
  double _degreesToRadians(double degrees) {
    return degrees * pi / 180;
  }
}

Clase: FuelPrice (Value Object)
class FuelPrice {
  final FuelType fuelType;
  final double value; // euros por litro
  final DateTime updatedAt;
  
  const FuelPrice({
    required this.fuelType,
    required this.value,
    required this.updatedAt,
  });
  
  bool isOlderThan(Duration duration) {
    return DateTime.now().difference(updatedAt) > duration;
  }
}

Clase: AppSettings (Entity)
class AppSettings {
  int searchRadius; // 5, 10, 20, 50
  FuelType preferredFuel;
  bool darkMode;
  DateTime? lastUpdateTimestamp;
  
  AppSettings({
    this.searchRadius = 10,
    this.preferredFuel = FuelType.gasolina95,
    this.darkMode = false,
    this.lastUpdateTimestamp,
  });
  
  Future<void> save() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setInt('searchRadius', searchRadius);
    await prefs.setString('preferredFuel', preferredFuel.toString());
    await prefs.setBool('darkMode', darkMode);
  }
  
  static Future<AppSettings> load() async {
    final prefs = await SharedPreferences.getInstance();
    return AppSettings(
      searchRadius: prefs.getInt('searchRadius') ?? 10,
      preferredFuel: FuelType.values.firstWhere(
        (e) => e.toString() == prefs.getString('preferredFuel'),
        orElse: () => FuelType.gasolina95,
      ),
      darkMode: prefs.getBool('darkMode') ?? false,
    );
  }
}

Enumeraciones
enum FuelType {
  gasolina95,
  dieselGasoleoA;
  
  String get displayName {
    switch (this) {
      case FuelType.gasolina95:
        return 'Gasolina 95';
      case FuelType.dieselGasoleoA:
        return 'DiÃ©sel GasÃ³leo A';
    }
  }
}

enum PriceRange {
  low,    // verde
  medium, // amarillo
  high;   // rojo
  
  Color get color {
    switch (this) {
      case PriceRange.low:
        return Colors.green;
      case PriceRange.medium:
        return Colors.orange;
      case PriceRange.high:
        return Colors.red;
    }
  }
}

DSI 5: DiseÃ±o de la Arquitectura de Datos
Esquema de Base de Datos Local (SQLite)
Tabla de gasolineras
CREATE TABLE gas_stations (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    latitude REAL NOT NULL,
    longitude REAL NOT NULL,
    address TEXT,
    locality TEXT,
    operator TEXT,
    cached_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_location (latitude, longitude)
);

Tabla de precios
CREATE TABLE fuel_prices (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    station_id TEXT NOT NULL,
    fuel_type TEXT NOT NULL,
    price REAL NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (station_id) REFERENCES gas_stations(id) ON DELETE CASCADE,
    UNIQUE(station_id, fuel_type)
);

Tabla de configuraciÃ³n (singleton)
CREATE TABLE app_settings (
    id INTEGER PRIMARY KEY CHECK (id = 1),
    search_radius INTEGER NOT NULL DEFAULT 10,
    preferred_fuel TEXT NOT NULL DEFAULT 'gasolina95',
    dark_mode INTEGER NOT NULL DEFAULT 0,
    last_api_sync DATETIME
);

Insertar configuraciÃ³n por defecto
INSERT INTO app_settings (id) VALUES (1);

Modelo de Datos API (Gobierno)
Endpoint esperado:
GET https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/

Estructura JSON de Respuesta (simplificada):
{
  "Fecha": "10/11/2025 08:30:00",
  "ListaEESSPrecio": [
    {
      "IDEESS": "1234",
      "RÃ³tulo": "REPSOL",
      "DirecciÃ³n": "AVENIDA PRINCIPAL 123",
      "Localidad": "MADRID",
      "Latitud": "40.416775",
      "Longitud (WGS84)": "-3.703790",
      "Precio Gasolina 95 E5": "1,459",
      "Precio Gasoleo A": "1,389"
    }
  ]
}

Modelo DTO:
class ApiGasStationResponse {
  final String fecha;
  final List<ApiGasStationDTO> listaEESSPrecio;
  
  factory ApiGasStationResponse.fromJson(Map<String, dynamic> json) {
    return ApiGasStationResponse(
      fecha: json['Fecha'],
      listaEESSPrecio: (json['ListaEESSPrecio'] as List)
          .map((e) => ApiGasStationDTO.fromJson(e))
          .toList(),
    );
  }
}

class ApiGasStationDTO {
  final String ideess;
  final String rotulo;
  final String direccion;
  final String localidad;
  final String latitud;
  final String longitud;
  final String? precioGasolina95;
  final String? precioDiesel;
  
  factory ApiGasStationDTO.fromJson(Map<String, dynamic> json) {
    return ApiGasStationDTO(
      ideess: json['IDEESS'] ?? '',
      rotulo: json['RÃ³tulo'] ?? '',
      direccion: json['DirecciÃ³n'] ?? '',
      localidad: json['Localidad'] ?? '',
      latitud: json['Latitud'] ?? '0',
      longitud: json['Longitud (WGS84)'] ?? '0',
      precioGasolina95: json['Precio Gasolina 95 E5'],
      precioDiesel: json['Precio Gasoleo A'],
    );
  }
  
  // Mapper a entidad de dominio
  GasStation toDomain() {
    List<FuelPrice> prices = [];
    
    if (precioGasolina95 != null) {
      double? price = _parsePrice(precioGasolina95!);
      if (price != null) {
        prices.add(FuelPrice(
          fuelType: FuelType.gasolina95,
          value: price,
          updatedAt: DateTime.now(),
        ));
      }
    }
    
    if (precioDiesel != null) {
      double? price = _parsePrice(precioDiesel!);
      if (price != null) {
        prices.add(FuelPrice(
          fuelType: FuelType.dieselGasoleoA,
          value: price,
          updatedAt: DateTime.now(),
        ));
      }
    }
    
    return GasStation(
      id: ideess,
      name: rotulo,
      latitude: double.tryParse(latitud.replaceAll(',', '.')) ?? 0.0,
      longitude: double.tryParse(longitud.replaceAll(',', '.')) ?? 0.0,
      address: direccion,
      locality: localidad,
      operator: rotulo,
      prices: prices,
    );
  }
  
  double? _parsePrice(String priceStr) {
    try {
      return double.parse(priceStr.replaceAll(',', '.'));
    } catch (_) {
      return null;
    }
  }
}

DSI 6: DiseÃ±o de Procesos
Proceso: ActualizaciÃ³n PeriÃ³dica de Datos
Estrategia:
-Timer periÃ³dico cada 30 minutos en foreground.
-WorkManager para actualizaciones en background (Android).

ImplementaciÃ³n:
class DataSyncService {
  Timer? _syncTimer;
  final GasStationRepository _repository;
  final Duration syncInterval = Duration(minutes: 30);
  
  void startPeriodicSync() {
    _syncTimer = Timer.periodic(syncInterval, (_) {
      _performSync();
    });
  }
  
  Future<void> _performSync() async {
    try {
      // 1. Verificar conectividad
      if (!await _hasInternetConnection()) {
        print('No internet, skipping sync');
        return;
      }
      
      // 2. Descargar datos frescos
      List<GasStation> freshData = await _repository.fetchRemoteStations();
      
      // 3. Comparar con cachÃ©
      List<GasStation> cachedData = await _repository.getCachedStations();
      
      if (_hasDataChanged(freshData, cachedData)) {
        // 4. Actualizar base de datos local
        await _repository.updateCache(freshData);
        
        // 5. Notificar a UI si estÃ¡ activa
        _notifyDataUpdated();
        
        print('Data synced successfully at ${DateTime.now()}');
      } else {
        print('No changes detected');
      }
      
    } catch (e) {
      print('Sync error: $e');
      // No interrumpir experiencia de usuario
    }
  }
  
  bool _hasDataChanged(List<GasStation> fresh, List<GasStation> cached) {
    if (fresh.length != cached.length) return true;
    
    // Comparar precios de primeras 10 gasolineras
    for (int i = 0; i < min(10, fresh.length); i++) {
      if (fresh[i].prices != cached[i].prices) {
        return true;
      }
    }
    return false;
  }
  
  void stopPeriodicSync() {
    _syncTimer?.cancel();
  }
}

Proceso: CÃ¡lculo de Rangos de Precio
Algoritmo:
class PriceRangeCalculator {
  static void assignPriceRanges(
    List<GasStation> stations,
    FuelType fuelType
  ) {
    // 1. Extraer todos los precios vÃ¡lidos
    List<double> prices = stations
        .map((s) => s.getPriceForFuel(fuelType))
        .whereType<double>()
        .toList();
    
    if (prices.isEmpty) return;
    
    // 2. Calcular percentiles
    prices.sort();
    int count = prices.length;
    
    double p33 = prices[(count * 0.33).floor()];
    double p66 = prices[(count * 0.66).floor()];
    
    // 3. Asignar rangos
    for (var station in stations) {
      double? price = station.getPriceForFuel(fuelType);
      if (price == null) continue;
      
      if (price <= p33) {
        station.priceRange = PriceRange.low;
      } else if (price <= p66) {
        station.priceRange = PriceRange.medium;
      } else {
        station.priceRange = PriceRange.high;
      }
    }
  }
}

DSI 7: DiseÃ±o de Interfaces
Widget: GasStationMarker
class GasStationMarker extends StatelessWidget {
  final GasStation station;
  final FuelType selectedFuel;
  final VoidCallback onTap;
  
  const GasStationMarker({
    required this.station,
    required this.selectedFuel,
    required this.onTap,
  });
  
  @override
  Widget build(BuildContext context) {
    double? price = station.getPriceForFuel(selectedFuel);
    Color markerColor = station.priceRange?.color ?? Colors.grey;
    
    return GestureDetector(
      onTap: onTap,
      child: Column(
        children: [
          // Precio destacado
          Container(
            padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: markerColor,
              borderRadius: BorderRadius.circular(4),
            ),
            child: Text(
              price != null ? '${price.toStringAsFixed(3)} â‚¬' : 'N/A',
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
                fontSize: 12,
              ),
            ),
          ),
          // Icono de surtidor
          Icon(
            Icons.local_gas_station,
            color: markerColor,
            size: 32,
          ),
        ],
      ),
    );
  }
}

Widget: InfoCard (Tarjeta Flotante)
class StationInfoCard extends StatelessWidget {
  final GasStation station;
  final FuelType selectedFuel;
  
  const StationInfoCard({
    required this.station,
    required this.selectedFuel,
  });
  
  @override
  Widget build(BuildContext context) {
    double? price = station.getPriceForFuel(selectedFuel);
    
    return Card(
      elevation: 8,
      margin: EdgeInsets.all(16),
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              station.name,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: 8),
            Text(
              station.address,
              style: TextStyle(
                fontSize: 14,
                color: Colors.grey[600],
              ),
            ),
            SizedBox(height: 12),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  '${selectedFuel.displayName}:',
                  style: TextStyle(fontSize: 16),
                ),
                Text(
                  price != null ? '${price.toStringAsFixed(3)} â‚¬/L' : 'N/A',
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: station.priceRange?.color,
                  ),
                ),
              ],
            ),
            SizedBox(height: 8),
            Row(
              children: [
                Icon(Icons.location_on, size: 16, color: Colors.grey),
                SizedBox(width: 4),
                Text(
                  station.distance != null
                      ? '${station.distance!.toStringAsFixed(1)} km'
                      : '',
                  style: TextStyle(color: Colors.grey),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

DSI 8: EspecificaciÃ³n de la ConstrucciÃ³n
Estructura de Directorios
lib/
â”œâ”€â”€ main.dart
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”œâ”€â”€ api_constants.dart
â”‚   â”‚   â””â”€â”€ app_constants.dart
â”‚   â”œâ”€â”€ theme/
â”‚   â”‚   â”œâ”€â”€ app_theme.dart
â”‚   â”‚   â””â”€â”€ colors.dart
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ distance_calculator.dart
â”‚       â””â”€â”€ price_formatter.dart
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ datasources/
â”‚   â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”‚   â””â”€â”€ database_datasource.dart
â”‚   â”‚   â””â”€â”€ remote/
â”‚   â”‚       â””â”€â”€ api_datasource.dart
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ gas_station_model.dart
â”‚   â”‚   â”œâ”€â”€ fuel_price_model.dart
â”‚   â”‚   â””â”€â”€ api_response_model.dart
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ gas_station_repository_impl.dart
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”œâ”€â”€ gas_station.dart
â”‚   â”‚   â”œâ”€â”€ fuel_price.dart
â”‚   â”‚   â””â”€â”€ app_settings.dart
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â””â”€â”€ gas_station_repository.dart
â”‚   â””â”€â”€ usecases/
â”‚       â”œâ”€â”€ get_nearby_stations.dart
â”‚       â”œâ”€â”€ filter_by_fuel_type.dart
â”‚       â””â”€â”€ calculate_distance.dart
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ blocs/
â”‚   â”‚   â”œâ”€â”€ map/
â”‚   â”‚   â”‚   â”œâ”€â”€ map_bloc.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ map_event.dart
â”‚   â”‚   â”‚   â””â”€â”€ map_state.dart
â”‚   â”‚   â””â”€â”€ settings/
â”‚   â”‚       â”œâ”€â”€ settings_bloc.dart
â”‚   â”‚       â”œâ”€â”€ settings_event.dart
â”‚   â”‚       â””â”€â”€ settings_state.dart
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”œâ”€â”€ splash_screen.dart
â”‚   â”‚   â”œâ”€â”€ map_screen.dart
â”‚   â”‚   â””â”€â”€ settings_screen.dart
â”‚   â””â”€â”€ widgets/
â”‚       â”œâ”€â”€ gas_station_marker.dart
â”‚       â”œâ”€â”€ info_card.dart
â”‚       â””â”€â”€ fuel_selector.dart
â””â”€â”€ services/
    â”œâ”€â”€ location_service.dart
    â”œâ”€â”€ api_service.dart
    â”œâ”€â”€ database_service.dart
    â””â”€â”€ sync_service.dart

Dependencias (pubspec.yaml)
name: BuscaGas
description: Localizador de gasolineras econÃ³micas en EspaÃ±a
version: 1.0.0+1

environment:
  sdk: ">=3.0.0 <4.0.0"

dependencies:
  flutter:
    sdk: flutter
  
  # State Management
  flutter_bloc: ^8.1.3
  
  # Networking
  http: ^1.1.0
  dio: ^5.3.3
  
  # Local Storage
  sqflite: ^2.3.0
  shared_preferences: ^2.2.2
  
  # Maps
  google_maps_flutter: ^2.5.0
  
  # Location
  geolocator: ^10.1.0
  permission_handler: ^11.0.1
  
  # Utilities
  intl: ^0.18.1
  equatable: ^2.0.5
  
dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.0
  mockito: ^5.4.2

DSI 9: DiseÃ±o de MigraciÃ³n y Carga Inicial de Datos
Estrategia de Primera Carga
class InitialDataLoader {
  final ApiDataSource _apiDataSource;
  final DatabaseDataSource _databaseDataSource;
  final AppSettings _settings;
  
  Future<void> performInitialLoad(BuildContext context) async {
    try {
      // 1. Verificar si es primera ejecuciÃ³n
      bool isFirstRun = await _isFirstRun();
      
      if (isFirstRun) {
        // 2. Mostrar diÃ¡logo de preferencia de tema
        bool darkMode = await _showThemeDialog(context);
        _settings.darkMode = darkMode;
        await _settings.save();
      }
      
      // 3. Solicitar permisos de ubicaciÃ³n
      bool locationGranted = await _requestLocationPermission();
      if (!locationGranted) {
        throw Exception('Permisos de ubicaciÃ³n requeridos');
      }
      
      // 4. Obtener ubicaciÃ³n actual
      Position position = await Geolocator.getCurrentPosition();
      
      // 5. Descargar datos iniciales
      List<GasStation> stations = await _apiDataSource.fetchAllStations();
      
      // 6. Guardar en base de datos local
      await _databaseDataSource.insertBatch(stations);
      
      // 7. Registrar timestamp de sincronizaciÃ³n
      _settings.lastUpdateTimestamp = DateTime.now();
      await _settings.save();
      
      // 8. Marcar como no primera ejecuciÃ³n
      await _setFirstRunComplete();
      
    } catch (e) {
      rethrow;
    }
  }
  
  Future<bool> _isFirstRun() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool('first_run') ?? true;
  }
  
  Future<void> _setFirstRunComplete() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('first_run', false);
  }
  
  Future<bool> _showThemeDialog(BuildContext context) async {
    return await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Preferencia de tema'),
        content: Text('Â¿Prefieres modo claro u oscuro?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text('â˜€ï¸ Claro'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: Text('ğŸŒ™ Oscuro'),
          ),
        ],
      ),
    ) ?? false;
  }
  
  Future<bool> _requestLocationPermission() async {
    LocationPermission permission = await Geolocator.checkPermission();
    
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
    }
    
    return permission == LocationPermission.always ||
           permission == LocationPermission.whileInUse;
  }
}

CSI - ConstrucciÃ³n del Sistema de InformaciÃ³n
CSI 1: PreparaciÃ³n del Entorno de ConstrucciÃ³n
Herramientas de Desarrollo
IDE:
-Visual Studio Code con extensiones Flutter
-Pruebas en Android Studio

SDK:
-Flutter SDK 3.10+
-Dart SDK 3.0+
-Android SDK (API 23-34)

Control de Versiones:
-Git
-Repositorio: GitHub/GitLab

GestiÃ³n de Dependencias:
-pub (gestor de paquetes de Dart)

CSI 2: GeneraciÃ³n del CÃ³digo de los Componentes
ImplementaciÃ³n de Repositorio
// domain/repositories/gas_station_repository.dart
abstract class GasStationRepository {
  Future<List<GasStation>> fetchRemoteStations();
  Future<List<GasStation>> getCachedStations();
  Future<void> updateCache(List<GasStation> stations);
  Future<List<GasStation>> getNearbyStations({
    required double latitude,
    required double longitude,
    required double radiusKm,
  });
}

// data/repositories/gas_station_repository_impl.dart
class GasStationRepositoryImpl implements GasStationRepository {
  final ApiDataSource _apiDataSource;
  final DatabaseDataSource _databaseDataSource;
  
  GasStationRepositoryImpl(this._apiDataSource, this._databaseDataSource);
  
  @override
  Future<List<GasStation>> fetchRemoteStations() async {
    try {
      final apiResponse = await _apiDataSource.getStations();
      return apiResponse.map((dto) => dto.toDomain()).toList();
    } catch (e) {
      throw Exception('Error fetching remote data: $e');
    }
  }
  
  @override
  Future<List<GasStation>> getCachedStations() async {
    return await _databaseDataSource.getAllStations();
  }
  
  @override
  Future<void> updateCache(List<GasStation> stations) async {
    await _databaseDataSource.clearAll();
    await _databaseDataSource.insertBatch(stations);
  }
  
  @override
  Future<List<GasStation>> getNearbyStations({
    required double latitude,
    required double longitude,
    required double radiusKm,
  }) async {
    List<GasStation> allStations = await getCachedStations();
    
    return allStations.where((station) {
      return station.isWithinRadius(latitude, longitude, radiusKm);
    }).toList();
  }
}

ImplementaciÃ³n de BLoC
// presentation/blocs/map/map_event.dart
abstract class MapEvent extends Equatable {
  const MapEvent();
  @override
  List<Object?> get props => [];
}

class LoadMapData extends MapEvent {
  final double latitude;
  final double longitude;
  
  const LoadMapData({required this.latitude, required this.longitude});
  
  @override
  List<Object?> get props => [latitude, longitude];
}

// presentation/blocs/map/map_event.dart
class ChangeFuelType extends MapEvent {
  final FuelType fuelType;
  const ChangeFuelType({required this.fuelType});
  @override
  List<Object?> get props => [fuelType];
}

class RecenterMap extends MapEvent {}

// map_state.dart
abstract class MapState extends Equatable {
  const MapState();
  @override
  List<Object?> get props => [];
}

class MapLoading extends MapState {}

class MapLoaded extends MapState {
  final List<GasStation> stations;
  final FuelType currentFuel;
  
  const MapLoaded({required this.stations, required this.currentFuel});
  @override
  List<Object?> get props => [stations, currentFuel];
}

class MapError extends MapState {
  final String message;
  const MapError({required this.message});
  @override
  List<Object?> get props => [message];
}

// map_bloc.dart
class MapBloc extends Bloc<MapEvent, MapState> {
  final GetNearbyStationsUseCase _getNearbyStations;
  final AppSettings _settings;
  
  MapBloc(this._getNearbyStations, this._settings) : super(MapLoading()) {
    on<LoadMapData>(_onLoadMapData);
    on<ChangeFuelType>(_onChangeFuelType);
    on<RecenterMap>(_onRecenterMap);
  }
  
  Future<void> _onLoadMapData(LoadMapData event, Emitter<MapState> emit) async {
    emit(MapLoading());
    try {
      final stations = await _getNearbyStations(
        latitude: event.latitude,
        longitude: event.longitude,
        radiusKm: _settings.searchRadius.toDouble(),
        fuelType: _settings.preferredFuel,
      );
      emit(MapLoaded(stations: stations, currentFuel: _settings.preferredFuel));
    } catch (e) {
      emit(MapError(message: e.toString()));
    }
  }
  
  Future<void> _onChangeFuelType(ChangeFuelType event, Emitter<MapState> emit) async {
    if (state is MapLoaded) {
      final currentState = state as MapLoaded;
      emit(MapLoaded(stations: currentState.stations, currentFuel: event.fuelType));
    }
  }
}

Pantalla Principal
// screens/map_screen.dart
class MapScreen extends StatefulWidget {
  @override
  State<MapScreen> createState() => _MapScreenState();
}

class _MapScreenState extends State<MapScreen> {
  GoogleMapController? _mapController;
  Position? _currentPosition;
  GasStation? _selectedStation;
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('BuscaGas'),
        actions: [
          IconButton(
            icon: Icon(Icons.settings),
            onPressed: () => Navigator.pushNamed(context, '/settings'),
          ),
        ],
      ),
      body: BlocBuilder<MapBloc, MapState>(
        builder: (context, state) {
          if (state is MapLoading) {
            return Center(child: CircularProgressIndicator());
          }
          
          if (state is MapError) {
            return Center(child: Text('Error: ${state.message}'));
          }
          
          if (state is MapLoaded) {
            return Stack(
              children: [
                GoogleMap(
                  initialCameraPosition: CameraPosition(
                    target: LatLng(_currentPosition!.latitude, _currentPosition!.longitude),
                    zoom: 13,
                  ),
                  markers: _buildMarkers(state.stations, state.currentFuel),
                  myLocationEnabled: true,
                  onMapCreated: (controller) => _mapController = controller,
                ),
                _buildFuelSelector(state.currentFuel),
                if (_selectedStation != null)
                  Positioned(
                    bottom: 20,
                    left: 20,
                    right: 20,
                    child: StationInfoCard(
                      station: _selectedStation!,
                      selectedFuel: state.currentFuel,
                    ),
                  ),
                _buildRecenterButton(),
              ],
            );
          }
          
          return SizedBox();
        },
      ),
    );
  }
}

CSI 3: EjecuciÃ³n de las Pruebas Unitarias
Pruebas de Casos de Uso

// test/domain/usecases/get_nearby_stations_test.dart
void main() {
  late GetNearbyStationsUseCase useCase;
  late MockGasStationRepository mockRepository;
  
  setUp(() {
    mockRepository = MockGasStationRepository();
    useCase = GetNearbyStationsUseCase(mockRepository);
  });
  
  test('debe retornar lista de gasolineras dentro del radio', () async {
    // Arrange
    final mockStations = [
      GasStation(id: '1', name: 'Test', latitude: 40.4, longitude: -3.7, prices: []),
    ];
    when(mockRepository.getNearbyStations(any, any, any))
        .thenAnswer((_) async => mockStations);
    
    // Act
    final result = await useCase(latitude: 40.4, longitude: -3.7, radiusKm: 10);
    
    // Assert
    expect(result, mockStations);
    verify(mockRepository.getNearbyStations(any, any, any)).called(1);
  });
}

Pruebas de CÃ¡lculo de Distancia
test('debe calcular distancia correctamente con fÃ³rmula Haversine', () {
  final station = GasStation(
    id: '1', name: 'Test',
    latitude: 40.416775, longitude: -3.703790,
    prices: [],
  );
  
  final distance = station.calculateDistance(40.420000, -3.700000);
  
  expect(distance, closeTo(0.4, 0.1)); // ~0.4 km con margen
});

Criterios de AceptaciÃ³n:
-Todas las pruebas deben pasar en CI/CD

CSI 4: EjecuciÃ³n de las Pruebas de IntegraciÃ³n
Prueba de IntegraciÃ³n API
test('debe descargar y parsear datos reales de la API', () async {
  final apiDataSource = ApiDataSource();
  
  final stations = await apiDataSource.getStations();
  
  expect(stations, isNotEmpty);
  expect(stations.first.id, isNotNull);
  expect(stations.first.latitude, isNotNull);
  expect(stations.first.prices, isNotEmpty);
});
```

Prueba de IntegraciÃ³n Base de Datos
test('debe guardar y recuperar gasolineras de SQLite', () async {
  final db = await DatabaseDataSource.initialize();
  
  final station = GasStation(
    id: 'test123',
    name: 'Test Station',
    latitude: 40.4,
    longitude: -3.7,
    prices: [FuelPrice(fuelType: FuelType.gasolina95, value: 1.45, updatedAt: DateTime.now())],
  );
  
  await db.insert(station);
  final retrieved = await db.getById('test123');
  
  expect(retrieved?.name, 'Test Station');
  expect(retrieved?.prices.length, 1);
});
```

Escenarios de IntegraciÃ³n:
-API â†’ Repository â†’ Base de Datos
-BLoC â†’ Repository â†’ UI
-Servicio de ubicaciÃ³n â†’ MapBloc â†’ Vista de mapa

RESUMEN EJECUTIVO
Proyecto BuscaGas es un sistema de informaciÃ³n mÃ³vil diseÃ±ado segÃºn MÃ©trica v3 que permite a conductores espaÃ±oles localizar las gasolineras mÃ¡s econÃ³micas en tiempo real mediante datos oficiales gubernamentales.

Alcance MVP:
-Mapa interactivo con geolocalizaciÃ³n.
-Filtrado por tipo de combustible (Gasolina 95, DiÃ©sel).
-CÃ³digo de color por rango de precios.
-ConfiguraciÃ³n bÃ¡sica y temas claro/oscuro.
-ActualizaciÃ³n automÃ¡tica de datos.

TecnologÃ­a:
-Framework: Flutter/Dart.
-Plataforma inicial: Android (API 23+).
-Arquitectura: Clean Architecture con BLoC.
-Fuente de datos: API pÃºblica del Gobierno de EspaÃ±a.

MÃ©tricas de Ã‰xito:
-Carga inicial < 3 segundos.
-BÃºsqueda efectiva < 10 segundos.
-PrecisiÃ³n 100% vs. fuente oficial.

FIN DE LA DOCUMENTACIÃ“N MÃ‰TRICA V3
